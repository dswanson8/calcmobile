<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-Line Calculator</title>
  <meta name="theme-color" content="#111827">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>Multi-Line Calculator</h1>
        <span class="pill">Offline-ready</span>
      </header>

      <div class="hint">Tip: Press <b>Enter</b> or tap <b>=</b> • Tap any <b>number</b> in history to insert it at the
        cursor.</div>

      <div class="toolbar">
        <button id="btn-clear">Clear history</button>
        <button id="btn-copy-last">Copy last result</button>
        <span id="status"></span>
      </div>

      <div class="input">
        <!-- readonly is set by JS on touch devices to suppress mobile keyboard -->
        <input id="line" type="text" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
          placeholder="Type an expression, e.g. (2+3)*4, 10%, sqrt(9), pi^2" />
        <button id="enter">=</button>
      </div>

      <div class="stack">
        <div id="history" aria-live="polite"></div>

        <!-- VIRTUAL KEYPAD -->
        <div class="numpad" aria-label="Calculator keypad">
          <!-- Row 1 -->
          <button class="key" data-key="CE">CE</button>
          <button class="key" data-key="/">/</button>
          <button class="key" data-key="*">*</button>
          <button class="key minus" data-key="-">−</button>

          <!-- Row 2 -->
          <button class="key" data-key="7">7</button>
          <button class="key" data-key="8">8</button>
          <button class="key" data-key="9">9</button>
          <button class="key tall plus" data-key="+">+</button>

          <!-- Row 3 -->
          <button class="key" data-key="4">4</button>
          <button class="key" data-key="5">5</button>
          <button class="key" data-key="6">6</button>
          <!-- plus continues -->

          <!-- Row 4 -->
          <button class="key" data-key="1">1</button>
          <button class="key" data-key="2">2</button>
          <button class="key" data-key="3">3</button>
          <button class="key tall enter" data-key="Enter">Enter</button>

          <!-- Row 5 -->
          <button class="key wide" data-key="0">0</button>
          <button class="key" data-key=".">.</button>
          <button class="key" data-key="BACK">⌫</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== UTIL =====
    const $ = (sel) => document.querySelector(sel);
    const historyEl = $('#history');
    const inputEl = $('#line');
    const statusEl = $('#status');

    // On touch devices, suppress mobile keyboard (use virtual keypad)
    if ('ontouchstart' in window) {
      inputEl.setAttribute('readonly', 'readonly');
    }

    // Local history
    let history = JSON.parse(localStorage.getItem('mlc_history') || '[]');
    render();

    // Buttons
    $('#enter').addEventListener('click', evaluateLine);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); evaluateLine(); }
    });
    $('#btn-clear').addEventListener('click', () => {
      history = []; localStorage.removeItem('mlc_history'); render();
    });
    $('#btn-copy-last').addEventListener('click', async () => {
      if (!history.length) return;
      const last = history[history.length - 1].result;
      insertAtCursor(String(last));
      try { await navigator.clipboard.writeText(String(last)); flashStatus('Copied last result'); } catch { }
    });

    // Keypad wiring
    document.querySelectorAll('.numpad .key').forEach(btn => {
      btn.addEventListener('click', () => {
        const k = btn.dataset.key;
        if (k === 'Enter') { $('#enter').click(); return; }
        if (k === 'CE') { inputEl.value = ''; inputEl.focus(); return; }
        if (k === 'BACK') {
          const s = inputEl.selectionStart ?? inputEl.value.length;
          const e = inputEl.selectionEnd ?? inputEl.value.length;
          if (s === e && s > 0) {
            inputEl.value = inputEl.value.slice(0, s - 1) + inputEl.value.slice(e);
            inputEl.setSelectionRange(s - 1, s - 1);
          } else {
            inputEl.value = inputEl.value.slice(0, s) + inputEl.value.slice(e);
            inputEl.setSelectionRange(s, s);
          }
          inputEl.focus();
          return;
        }
        insertAtCursor(k);
      });
    });

    // ===== CORE =====
    function evaluateLine() {
      const raw = inputEl.value.trim();
      if (!raw) return;
      try {
        const prepared = prepare(raw);
        // eslint-disable-next-line no-new-func
        const value = Function('"use strict"; return (' + prepared + ')')();
        const result = fixFloat(value);
        history.push({ expr: raw, result });
        localStorage.setItem('mlc_history', JSON.stringify(history));
        inputEl.value = '';
        render(true);
      } catch (err) {
        flashStatus('Invalid expression');
      }
    }

    function render(scroll = false) {
      if (!history.length) { historyEl.innerHTML = '<div class="empty">No calculations yet.</div>'; return; }
      historyEl.innerHTML = history.map((row, i) => `
        <div class="row" data-idx="${i}">
          <div class="expr">${highlightNumbers(escapeHtml(row.expr))}</div>
          <div class="result">= <span class="clickable" data-val="${row.result}">${row.result}</span></div>
        </div>
      `).join('');
      historyEl.querySelectorAll('.clickable').forEach(el => {
        el.addEventListener('click', (e) => {
          const val = e.currentTarget.getAttribute('data-val');
          insertAtCursor(val);
          navigator.clipboard?.writeText(String(val)).catch(() => { });
          flashStatus(`Inserted ${val}`);
        });
      });
      if (scroll) historyEl.scrollTop = historyEl.scrollHeight;
    }

    function insertAtCursor(text) {
      const start = inputEl.selectionStart ?? inputEl.value.length;
      const end = inputEl.selectionEnd ?? inputEl.value.length;
      inputEl.setRangeText(text, start, end, 'end');
      inputEl.focus();
    }

    function fixFloat(n) {
      const rounded = Math.round((n + Number.EPSILON) * 1e12) / 1e12; // up to 12 dp for display
      return Number(rounded.toString());
    }

    // Sanitize & map input to safe JS with Math.* and operators
    function prepare(s) {
      // Allow digits, operators, dots, commas, spaces, parentheses, and whitelisted fn/const names
      if (/[^0-9+\-*/%^().,\sA-Za-z]/.test(s)) throw new Error('bad');
      // Normalize symbols to JS operators
      s = s.replace(/[−–]/g, '-').replace(/[×x]/gi, '*').replace(/[÷]/g, '/');
      // Percent: 50% → (50/100)
      s = s.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)');
      // Power: a^b → a**b
      s = s.replace(/\^/g, '**');
      // Map constants/functions
      const map = {
        '\\bpi\\b': 'Math.PI', '\\be\\b': 'Math.E',
        '\\bsqrt\\b': 'Math.sqrt', '\\bsin\\b': 'Math.sin', '\\bcos\\b': 'Math.cos', '\\btan\\b': 'Math.tan',
        '\\blog10\\b': 'Math.log10', '\\blog\\b': 'Math.log10', '\\bln\\b': 'Math.log'
      };
      for (const [k, v] of Object.entries(map)) s = s.replace(new RegExp(k, 'gi'), v);
      // Disallow unknown identifiers
      const ids = s.match(/[A-Za-z_]\w*/g);
      if (ids && ids.some(id => !/^Math$/i.test(id))) throw new Error('id');
      return s;
    }

    function highlightNumbers(html) {
      // Wrap standalone numbers with clickable spans
      return html.replace(/(?<![A-Za-z_])(\d+(?:\.\d+)?)(?![A-Za-z_])/g, '<span class="clickable" data-val="$1">$1</span>');
    }
    function escapeHtml(s) { return s.replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }
    function flashStatus(msg) { statusEl.textContent = msg; clearTimeout(flashStatus._t); flashStatus._t = setTimeout(() => statusEl.textContent = '', 1600); }

    // Optional: register service worker if you have one in the repo
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => { });
      });
    }
  </script>
</body>

</html>